#' Write a minimal Dockerfile for a Binder
#'
#' @param base Your Docker base. I recommend that you use a binder base from the
#'   \href{https://www.rocker-project.org/images/}{rocker project}. This daily
#'   image will contain all the Jupyter hub elements + Rstudio Server + the
#'   tidyverse (which cuts down on installation time). The only thing then left
#'   to do is to install any additional packages listed in your DESCRIPTION
#'   file, which will be done during the build_binder step.
#' @param maintainer Maintainer of the Dockerfile
#' @param r_date  The date for which you'd like to lock down this project.
#'   Projects that match current release date go to "latest". This will be
#'   automatically determined from your code, so the recommendation is not to
#'   override this unless you have a specific reason to do so.
#' @param path path to binder repo. Defaults to current location.
#'
#' @importFrom glue glue
#' @export
#' 
write_dockerfile <-
  function(base = NULL,
           path = ".",
           maintainer = "karthik",
           r_date = NULL)
  {
    if (!fs::file_exists("DESCRIPTION")) {
      stop(
        "Your compendium does not have a DESCRIPTION file.  Without one, this Dockerfile approach will not be able to install dependencies. Run write_compendium_description() before running this function",
        call. = FALSE
      )
    }
    
    # Grab GitHub username and repo name to populate the path to the DESCRIPTION file in the Dockerfile
    user <- gh::gh_tree_remote(path)$username
    repo <- gh::gh_tree_remote(path)$repo
    
    # If the user does not specify a date, use the date of the last touched file on the project
    if (is.null(r_date)) {
      version = r_version_lookup(last_modification_date())
    } else {
      version = r_version_lookup(r_date)
    }
    
    cliapp::cli_alert("Setting R version to {version}")
    R_VERSION = version
    # Set the date for R packages
    
    DATE = ifelse(is.null(r_date), last_modification_date("."), r_date)
    # TODO: Not sure why I need to do this because otherwise I get a numeric
    DATE = as.Date(DATE, origin = "1970-01-01")
    MAINTAINER = maintainer
    
    # Set the binder base here. Users can override this by passing a base argument
    if (is.null(base)) {
      base = glue("rocker/binder:{R_VERSION}")
    }
    
    # Now we glue the Dockerfile together
    
    glue::glue(
      "
FROM [base]
LABEL maintainer='[MAINTAINER]'
USER root
COPY . ${HOME}
RUN chown -R ${NB_USER} ${HOME}
USER ${NB_USER}
RUN wget https://github.com/[user]/[repo]/raw/master/DESCRIPTION && R -e \"options(repos = list(CRAN = 'http://mran.revolutionanalytics.com/snapshot/[DATE]/')); devtools::install_deps()\"
",
      .open = "[",
      .close = "]"
    ) -> docker_contents
    path <- sanitize_path(path) # To kill trailing slashes
    fs::dir_create(glue("{path}/.binder"))
    fileConn <- file(glue("{path}/.binder/Dockerfile"))
    writeLines(docker_contents, fileConn)
    close(fileConn)

    cliapp::cli_alert_success(glue("Dockerfile generated at {path}/.binder/Dockerfile"))
  }
